第15章 向量自回归与VEC模型

## **向量自回归与整合变量（Integrated Variables）**

在这一章中，我们需要讨论带有I(1)的向量自回归过程。一般VAR模型的过程为
    一个n维时间序列${{Y_t}}$， 而且$$Y=C+\theta _{1}Y_{t-1}+\theta _{2}Y_{t-2}...+\theta _{p}Y_{t-p}+\varepsilon _{t}$$


其中$$E(\varepsilon )=0, E(\varepsilon {\varepsilon }')=\left\{\begin{matrix}
\pi  &  t=\tau  \\ 0
 &  t\neq \tau
\end{matrix}\right.$$


$\varepsilon$ 在不同时刻独立同分布，且服从正态分布，则称为p阶向量自回归模型。 


向量自回归模型的一般步骤为
* 对原始数据进行平稳性检验，也就是ADF检验
* 对应变量和自变量做协整检验
* LR（long-run）定阶
* 估计参数



```python
import statsmodels.api as sm
import statsmodels.stats.diagnostic
import matplotlib.pyplot as plt
import pandas as pd
import numpy as np

```


```python
dta = sm.datasets.webuse('lutkepohl2', 'https://www.stata-press.com/data/r12/')#获取数据
dta.index = dta.qtr
endog = dta.loc['1960-04-01':'1978-10-01', ['dln_inv', 'dln_inc', 'dln_consump']]
```


```python
exog = endog['dln_consump']
mod = sm.tsa.VARMAX(endog[['dln_inv', 'dln_inc']], order=(2,0), trend='n', exog=exog)
res = mod.fit(maxiter=1000, disp=False)
print(res.summary())
```




                                 Statespace Model Results                             
    ==================================================================================
    Dep. Variable:     ['dln_inv', 'dln_inc']   No. Observations:                   75
    Model:                            VARX(2)   Log Likelihood                 361.038
    Date:                    Wed, 12 Aug 2020   AIC                           -696.077
    Time:                            17:59:20   BIC                           -665.949
    Sample:                        04-01-1960   HQIC                          -684.047
                                 - 10-01-1978                                         
    Covariance Type:                      opg                                         
    ===================================================================================
    Ljung-Box (Q):                61.24, 39.25   Jarque-Bera (JB):          11.14, 2.41
    Prob(Q):                        0.02, 0.50   Prob(JB):                   0.00, 0.30
    Heteroskedasticity (H):         0.45, 0.40   Skew:                      0.16, -0.38
    Prob(H) (two-sided):            0.05, 0.03   Kurtosis:                   4.86, 3.44
                                Results for equation dln_inv                            
    ====================================================================================
                           coef    std err          z      P>|z|      [0.025      0.975]
    ------------------------------------------------------------------------------------
    L1.dln_inv          -0.2388      0.093     -2.564      0.010      -0.421      -0.056
    L1.dln_inc           0.2861      0.450      0.636      0.525      -0.595       1.167
    L2.dln_inv          -0.1665      0.155     -1.072      0.284      -0.471       0.138
    L2.dln_inc           0.0628      0.421      0.149      0.881      -0.762       0.888
    beta.dln_consump     0.9750      0.638      1.528      0.127      -0.276       2.226
                                Results for equation dln_inc                            
    ====================================================================================
                           coef    std err          z      P>|z|      [0.025      0.975]
    ------------------------------------------------------------------------------------
    L1.dln_inv           0.0633      0.036      1.773      0.076      -0.007       0.133
    L1.dln_inc           0.0811      0.107      0.758      0.448      -0.129       0.291
    L2.dln_inv           0.0104      0.033      0.315      0.753      -0.054       0.075
    L2.dln_inc           0.0350      0.134      0.261      0.794      -0.228       0.298
    beta.dln_consump     0.7731      0.112      6.879      0.000       0.553       0.993
                                      Error covariance matrix                                   
    ============================================================================================
                                   coef    std err          z      P>|z|      [0.025      0.975]
    --------------------------------------------------------------------------------------------
    sqrt.var.dln_inv             0.0434      0.004     12.284      0.000       0.036       0.050
    sqrt.cov.dln_inv.dln_inc   5.58e-05      0.002      0.028      0.978      -0.004       0.004
    sqrt.var.dln_inc             0.0109      0.001     11.222      0.000       0.009       0.013
    ============================================================================================
    
    Warnings:
    [1] Covariance matrix calculated using the outer product of gradients (complex-step).


以上 为VAR（2）的一个估计实例

## 向量自回归与协整变量（Cointegrated Variables）

**协整** ：如果所考虑的时间序列具有相同的单整阶数，且某种协整向量使得组合时间序列的单整阶数降低，则称这些时间序列之间存在显著的协整关系。

### 例15.2：用VAR（2）估计rs 与rs20 这两个向量。估计时使用C作为外生变量。

首先用VAR（2）估计rs 与rs20 这两个向量。估计时使用C作为外生变量。


```python
df=pd.read_excel("/root/experiment01/rs1.xlsx")
df.head()
df.tail()
```


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>_date_</th>
      <th>rs</th>
      <th>r20</th>
      <th>c</th>
      <th>resid</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>823</td>
      <td>2020-08-01</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>824</td>
      <td>2020-09-01</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>825</td>
      <td>2020-10-01</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>826</td>
      <td>2020-11-01</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
    <tr>
      <td>827</td>
      <td>2020-12-01</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.0</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>



```python
endog=df[['rs', 'r20']].dropna()
ex=df["c"][:len(endog)]
endog
ex
```




    0     -0.012296
    1      0.233268
    2     -0.081877
    3     -0.113973
    4      0.007990
             ...   
    781    0.000000
    782    0.000000
    783    0.000000
    784    0.000000
    785    0.000000
    Name: c, Length: 786, dtype: float64




```python
mod = sm.tsa.VARMAX(endog, order=(2,0), trend='n', exog=ex)
res = mod.fit(maxiter=1000, disp=False)
print(res.summary())
```

                               Statespace Model Results                           
    ==============================================================================
    Dep. Variable:          ['rs', 'r20']   No. Observations:                  828
    Model:                        VARX(2)   Log Likelihood                -471.867
    Date:                Wed, 12 Aug 2020   AIC                            969.733
    Time:                        19:22:00   BIC                           1031.080
    Sample:                             0   HQIC                           993.262
                                    - 828                                         
    Covariance Type:                  opg                                         
    ===================================================================================
    Ljung-Box (Q):                    nan, nan   Jarque-Bera (JB):      1663.06, 188.00
    Prob(Q):                          nan, nan   Prob(JB):                   0.00, 0.00
    Heteroskedasticity (H):         0.17, 0.60   Skew:                      1.14, -0.18
    Prob(H) (two-sided):            0.00, 0.00   Kurtosis:                   9.75, 5.37
                               Results for equation rs                            
    ==============================================================================
                     coef    std err          z      P>|z|      [0.025      0.975]
    ------------------------------------------------------------------------------
    L1.rs          1.1999      0.027     44.000      0.000       1.146       1.253
    L1.r20         0.2807      0.053      5.268      0.000       0.176       0.385
    L2.rs         -0.2280      0.027     -8.468      0.000      -0.281      -0.175
    L2.r20        -0.2577      0.053     -4.840      0.000      -0.362      -0.153
    beta.c        -0.2672      1.567     -0.170      0.865      -3.339       2.804
                               Results for equation r20                           
    ==============================================================================
                     coef    std err          z      P>|z|      [0.025      0.975]
    ------------------------------------------------------------------------------
    L1.rs         -0.0206      0.021     -0.988      0.323      -0.061       0.020
    L1.r20         1.2833      0.028     45.356      0.000       1.228       1.339
    L2.rs          0.0228      0.021      1.081      0.280      -0.019       0.064
    L2.r20        -0.2867      0.028    -10.279      0.000      -0.341      -0.232
    beta.c         0.0478      0.664      0.072      0.943      -1.254       1.350
                                  Error covariance matrix                              
    ===================================================================================
                          coef    std err          z      P>|z|      [0.025      0.975]
    -----------------------------------------------------------------------------------
    sqrt.var.rs         0.4257      0.006     69.935      0.000       0.414       0.438
    sqrt.cov.rs.r20     0.1282      0.007     18.027      0.000       0.114       0.142
    sqrt.var.r20        0.2492      0.005     53.063      0.000       0.240       0.258
    ===================================================================================
    



```python
# 使用VAR(3)估计
mod = sm.tsa.VARMAX(endog, order=(3,0), trend='n', exog=ex)
res = mod.fit(maxiter=1000, disp=False)
print(res.summary())
```

                               Statespace Model Results                           
    ==============================================================================
    Dep. Variable:          ['rs', 'r20']   No. Observations:                  828
    Model:                        VARX(3)   Log Likelihood                -465.030
    Date:                Wed, 12 Aug 2020   AIC                            964.061
    Time:                        19:39:24   BIC                           1044.284
    Sample:                             0   HQIC                           994.829
                                    - 828                                         
    Covariance Type:                  opg                                         
    ===================================================================================
    Ljung-Box (Q):                    nan, nan   Jarque-Bera (JB):      1694.47, 168.11
    Prob(Q):                          nan, nan   Prob(JB):                   0.00, 0.00
    Heteroskedasticity (H):         0.17, 0.57   Skew:                      1.18, -0.13
    Prob(H) (two-sided):            0.00, 0.00   Kurtosis:                   9.80, 5.25
                               Results for equation rs                            
    ==============================================================================
                     coef    std err          z      P>|z|      [0.025      0.975]
    ------------------------------------------------------------------------------
    L1.rs          1.1957      0.029     41.645      0.000       1.139       1.252
    L1.r20         0.2982      0.056      5.373      0.000       0.189       0.407
    L2.rs         -0.1852      0.052     -3.551      0.000      -0.287      -0.083
    L2.r20        -0.3507      0.093     -3.772      0.000      -0.533      -0.168
    L3.rs         -0.0397      0.040     -0.996      0.319      -0.118       0.038
    L3.r20         0.0764      0.063      1.219      0.223      -0.046       0.199
    beta.c        -0.2798      1.482     -0.189      0.850      -3.184       2.624
                               Results for equation r20                           
    ==============================================================================
                     coef    std err          z      P>|z|      [0.025      0.975]
    ------------------------------------------------------------------------------
    L1.rs         -0.0106      0.022     -0.492      0.623      -0.053       0.032
    L1.r20         1.3101      0.030     43.907      0.000       1.252       1.369
    L2.rs          0.0335      0.034      0.980      0.327      -0.034       0.101
    L2.r20        -0.4525      0.046     -9.785      0.000      -0.543      -0.362
    L3.rs         -0.0210      0.023     -0.913      0.361      -0.066       0.024
    L3.r20         0.1392      0.029      4.803      0.000       0.082       0.196
    beta.c         0.0453      0.708      0.064      0.949      -1.342       1.433
                                  Error covariance matrix                              
    ===================================================================================
                          coef    std err          z      P>|z|      [0.025      0.975]
    -----------------------------------------------------------------------------------
    sqrt.var.rs         0.4252      0.006     69.958      0.000       0.413       0.437
    sqrt.cov.rs.r20     0.1270      0.007     18.039      0.000       0.113       0.141
    sqrt.var.r20        0.2473      0.005     52.501      0.000       0.238       0.257
    ===================================================================================
    
    



### 例15.3：检验VECM模型在英国利率上的表现

```python
from statsmodels.tsa.vector_ar.vecm import VECM
model = VECM(endog = endog, k_ar_diff = 7, coint_rank = 6, deterministic = 'co')
res = model.fit()

X_pred = res.predict(steps=10)
X_pred
```


    ---------------------------------------------------------------------------
    
    NameError                                 Traceback (most recent call last)
    
    <ipython-input-1-d4a2bef29d17> in <module>
          1 from statsmodels.tsa.vector_ar.vecm import VECM
    ----> 2 model = VECM(endog = endog, k_ar_diff = 7, coint_rank = 6, deterministic = 'co')
          3 res = model.fit()
          4 
          5 X_pred = res.predict(steps=10)


    NameError: name 'endog' is not defined



```python
#预测结果
plt.plot(X_pred)
plt.legend(['rs',"r20"])
plt.show()
```

<img src="https://s1.ax1x.com/2020/08/14/dCvBh6.png" alt="dCvBh6.png" border="0" />

### 例15.4：

```python
import numpy as np
import pandas
import statsmodels.api as sm
from statsmodels.tsa.api import VAR,SVAR

```


```python
model = VAR(endog)
results = model.fit(3)
```


```python
results.summary()
```




      Summary of Regression Results   
    ==================================
    Model:                         VAR
    Method:                        OLS
    Date:           Wed, 12, Aug, 2020
    Time:                     21:16:26
    --------------------------------------------------------------------
    No. of Equations:         2.00000    BIC:                   -4.39319
    Nobs:                     783.000    HQIC:                  -4.44450
    Log likelihood:          -455.483    FPE:                  0.0113724
    AIC:                     -4.47656    Det(Omega_mle):       0.0111718
    --------------------------------------------------------------------
    Results for equation rs
    =========================================================================
                coefficient       std. error           t-stat            prob
    -------------------------------------------------------------------------
    const         -0.005228         0.036862           -0.142           0.887
    L1.rs          1.199313         0.040129           29.886           0.000
    L1.r20         0.294782         0.061048            4.829           0.000
    L2.rs         -0.187626         0.062012           -3.026           0.002
    L2.r20        -0.348557         0.094870           -3.674           0.000
    L3.rs         -0.038836         0.039528           -0.982           0.326
    L3.r20         0.076997         0.061701            1.248           0.212
    =========================================================================
    
    Results for equation r20
    =========================================================================
                coefficient       std. error           t-stat            prob
    -------------------------------------------------------------------------
    const          0.022874         0.024202            0.945           0.345
    L1.rs         -0.009637         0.026347           -0.366           0.715
    L1.r20         1.309279         0.040081           32.665           0.000
    L2.rs          0.033408         0.040715            0.821           0.412
    L2.r20        -0.452051         0.062288           -7.257           0.000
    L3.rs         -0.019845         0.025952           -0.765           0.444
    L3.r20         0.136011         0.040510            3.357           0.001
    =========================================================================
    
    Correlation matrix of residuals
                 rs       r20
    rs     1.000000  0.459487
    r20    0.459487  1.000000


```python
#results.plot()
```


```python
res=results.test_causality('rs', ['r20', 'rs'], kind='wald')
print(res)
```

    <statsmodels.tsa.vector_ar.hypothesis_test_results.CausalityTestResults object. H_0: %s do not Granger-cause rs: reject at 5% significance level. Test statistic: 62868.469, critical value: 12.592>, p-value: 0.000>

```python
results.to_vecm()
```


    {'Gamma': array([[ 0.22646186,  0.27155938,  0.0388359 , -0.07699749],
            [-0.01356378,  0.31604068,  0.01984455, -0.13601057]]),
     'Pi': array([[-0.02714869,  0.02322247],
            [ 0.00392675, -0.00676172]])}



### 例15.5：LA-VAR causality tests for U.K. interest rates


```python
import numpy as np
import pandas
import statsmodels.api as sm
from statsmodels.tsa.api import VAR
model = VAR(endog)
results = model.fit(4)
res=results.test_causality('rs', ['r20', 'rs'])
print(res)
```



### 例15.6：


```python
from statsmodels.tsa.vector_ar.vecm import VECM
model = VECM(endog = endog, k_ar_diff = 2, coint_rank = 1, deterministic = 'co')
res = model.fit()
res.conf_int_det_coef_coint()
```



### 例15.7：


```python
data=pd.read_excel("/root/experiment01/trf1.xlsx")

data=data.drop(columns = ['_date_'])
data=data.dropna()
data
```



<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>trf</th>
      <th>temp</th>
      <th>c</th>
      <th>volc</th>
      <th>amo</th>
      <th>soi</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.155966</td>
      <td>0.058267</td>
      <td>0.309571</td>
      <td>0.219079</td>
      <td>0.205083</td>
      <td>-0.025000</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.150523</td>
      <td>-0.010733</td>
      <td>0.083041</td>
      <td>0.229017</td>
      <td>0.143583</td>
      <td>-0.008333</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.173692</td>
      <td>0.072267</td>
      <td>0.026940</td>
      <td>0.231073</td>
      <td>0.155917</td>
      <td>-0.138333</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.217857</td>
      <td>0.041267</td>
      <td>0.132820</td>
      <td>0.222848</td>
      <td>0.097083</td>
      <td>0.062500</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.251133</td>
      <td>0.028267</td>
      <td>0.188829</td>
      <td>0.218736</td>
      <td>0.020000</td>
      <td>-0.026667</td>
    </tr>
    <tr>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <td>145</td>
      <td>2.282982</td>
      <td>0.725267</td>
      <td>0.390467</td>
      <td>0.000000</td>
      <td>0.101667</td>
      <td>0.228333</td>
    </tr>
    <tr>
      <td>146</td>
      <td>2.342985</td>
      <td>0.773267</td>
      <td>0.390467</td>
      <td>0.000000</td>
      <td>0.213333</td>
      <td>-0.019167</td>
    </tr>
    <tr>
      <td>147</td>
      <td>2.374454</td>
      <td>0.802267</td>
      <td>0.390467</td>
      <td>0.000000</td>
      <td>0.166500</td>
      <td>0.041667</td>
    </tr>
    <tr>
      <td>148</td>
      <td>2.376194</td>
      <td>0.870267</td>
      <td>0.390467</td>
      <td>0.000000</td>
      <td>0.102250</td>
      <td>-0.068333</td>
    </tr>
    <tr>
      <td>149</td>
      <td>2.376060</td>
      <td>1.049267</td>
      <td>0.390467</td>
      <td>0.000000</td>
      <td>0.114750</td>
      <td>-0.191667</td>
    </tr>
  </tbody>
</table>



```python
endog=data[['trf', 'temp']].copy()
exo=data[["volc", "soi", "amo"]].copy()
amo=data["amo"].copy()
```


```python
exo["amo(-1)"]=amo.shift(-1)

endog=endog[:-1]
```


```python
exo=exo.dropna()
exo


```


<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>volc</th>
      <th>soi</th>
      <th>amo</th>
      <th>amo(-1)</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>0.219079</td>
      <td>-0.025000</td>
      <td>0.205083</td>
      <td>0.143583</td>
    </tr>
    <tr>
      <td>1</td>
      <td>0.229017</td>
      <td>-0.008333</td>
      <td>0.143583</td>
      <td>0.155917</td>
    </tr>
    <tr>
      <td>2</td>
      <td>0.231073</td>
      <td>-0.138333</td>
      <td>0.155917</td>
      <td>0.097083</td>
    </tr>
    <tr>
      <td>3</td>
      <td>0.222848</td>
      <td>0.062500</td>
      <td>0.097083</td>
      <td>0.020000</td>
    </tr>
    <tr>
      <td>4</td>
      <td>0.218736</td>
      <td>-0.026667</td>
      <td>0.020000</td>
      <td>0.033167</td>
    </tr>
    <tr>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <td>144</td>
      <td>0.000000</td>
      <td>0.132500</td>
      <td>0.348917</td>
      <td>0.101667</td>
    </tr>
    <tr>
      <td>145</td>
      <td>0.000000</td>
      <td>0.228333</td>
      <td>0.101667</td>
      <td>0.213333</td>
    </tr>
    <tr>
      <td>146</td>
      <td>0.000000</td>
      <td>-0.019167</td>
      <td>0.213333</td>
      <td>0.166500</td>
    </tr>
    <tr>
      <td>147</td>
      <td>0.000000</td>
      <td>0.041667</td>
      <td>0.166500</td>
      <td>0.102250</td>
    </tr>
    <tr>
      <td>148</td>
      <td>0.000000</td>
      <td>-0.068333</td>
      <td>0.102250</td>
      <td>0.114750</td>
    </tr>
  </tbody>
</table>



```python
model = statsmodels.tsa.vector_ar.vecm.VECM(endog,exog=exo,k_ar_diff = 4, coint_rank = 2, deterministic = 'co')
results = model.fit()
print(results.summary(alpha=0.05))
```

    Det. terms outside the coint. relation & lagged endog. parameters for equation trf
    ==============================================================================
                     coef    std err          z      P>|z|      [0.025      0.975]
    ------------------------------------------------------------------------------
    const         -0.0035      0.002     -2.026      0.043      -0.007      -0.000
    exog1         -0.0024      0.003     -0.826      0.409      -0.008       0.003
    exog2          0.0008      0.008      0.111      0.912      -0.014       0.016
    exog3         -0.0113      0.007     -1.650      0.099      -0.025       0.002
    exog4          0.0020      0.006      0.308      0.758      -0.011       0.015
    L1.trf         1.4602      0.071     20.644      0.000       1.322       1.599
    L1.temp        0.0180      0.011      1.637      0.102      -0.004       0.039
    L2.trf        -1.3739      0.122    -11.220      0.000      -1.614      -1.134
    L2.temp        0.0148      0.010      1.499      0.134      -0.005       0.034
    L3.trf         0.8562      0.123      6.944      0.000       0.615       1.098
    L3.temp        0.0136      0.009      1.555      0.120      -0.004       0.031
    L4.trf        -0.6017      0.072     -8.331      0.000      -0.743      -0.460
    L4.temp        0.0098      0.008      1.211      0.226      -0.006       0.026
    Det. terms outside the coint. relation & lagged endog. parameters for equation temp
    ==============================================================================
                     coef    std err          z      P>|z|      [0.025      0.975]
    ------------------------------------------------------------------------------
    const         -0.0567      0.013     -4.517      0.000      -0.081      -0.032
    exog1          0.0748      0.021      3.597      0.000       0.034       0.116
    exog2         -0.3637      0.056     -6.531      0.000      -0.473      -0.255
    exog3          0.3125      0.050      6.275      0.000       0.215       0.410
    exog4         -0.0141      0.047     -0.302      0.762      -0.106       0.078
    L1.trf        -0.0225      0.516     -0.044      0.965      -1.034       0.989
    L1.temp       -0.1102      0.080     -1.377      0.169      -0.267       0.047
    L2.trf        -0.4081      0.893     -0.457      0.648      -2.159       1.343
    L2.temp       -0.0968      0.072     -1.348      0.178      -0.238       0.044
    L3.trf         0.7501      0.899      0.834      0.404      -1.013       2.513
    L3.temp       -0.0974      0.064     -1.524      0.127      -0.223       0.028
    L4.trf        -0.6468      0.527     -1.228      0.220      -1.679       0.386
    L4.temp        0.0304      0.059      0.512      0.609      -0.086       0.147
                    Loading coefficients (alpha) for equation trf                 
    ==============================================================================
                     coef    std err          z      P>|z|      [0.025      0.975]
    ------------------------------------------------------------------------------
    ec1            0.0220      0.005      4.299      0.000       0.012       0.032
    ec2           -0.0207      0.011     -1.874      0.061      -0.042       0.001
                    Loading coefficients (alpha) for equation temp                
    ==============================================================================
                     coef    std err          z      P>|z|      [0.025      0.975]
    ------------------------------------------------------------------------------
    ec1            0.2554      0.037      6.856      0.000       0.182       0.328
    ec2           -0.6016      0.081     -7.449      0.000      -0.760      -0.443
              Cointegration relations for loading-coefficients-column 1           
    ==============================================================================
                     coef    std err          z      P>|z|      [0.025      0.975]
    ------------------------------------------------------------------------------
    beta.1         1.0000          0          0      0.000       1.000       1.000
    beta.2              0          0          0      0.000           0           0
              Cointegration relations for loading-coefficients-column 2           
    ==============================================================================
                     coef    std err          z      P>|z|      [0.025      0.975]
    ------------------------------------------------------------------------------
    beta.1      2.776e-17          0          0      0.000    2.78e-17    2.78e-17
    beta.2         1.0000          0          0      0.000       1.000       1.000
    ==============================================================================



```python
test=results.test_causality('trf', ['trf', 'temp'], kind='wald')
print(test)
data["c"]
```

    <statsmodels.tsa.vector_ar.hypothesis_test_results.CausalityTestResults object. H_0: %s do not Granger-cause trf: reject at 5% significance level. Test statistic: 529094.027, critical value: 18.307>, p-value: 0.000>
    
    0      0.309571
    1      0.083041
    2      0.026940
    3      0.132820
    4      0.188829
             ...   
    145    0.390467
    146    0.390467
    147    0.390467
    148    0.390467
    149    0.390467
    Name: c, Length: 150, dtype: float64



# Chapter16：组合与计数时间序列

## 预测成分时间序列

在前面的章节中， 我们考虑到时间序列通常没有任何限制，除了它们有一 个自然的下界，这通常是零。然而，有一些级数或级数的组受到进一步的 约束。在对这样的序列建模时，一个 “好的”模型应该不能预测违反已知 约束的值， 也就是说，这个模型应该是 “ 预测一致的 ” 。“本章考虑这类 级数的两个例子:(1)复合时间序列，其中一组级数被定义为一个整体的份额， 因此它们必须是加起来等于一的正分数 ;(2)“计数”时间序列只能取正的、 通常较低的整数值。

### 例16.1：


```python
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
```


```python
df=pd.read_excel("/root/experiment01/x1.xlsx")
x1=np.array(df["x1"])
x2=np.array(df["x2"])
x3=np.array(df["x3"])
plt.plot(x1)
plt.plot(x2)
plt.plot(x3)
plt.legend(['BMI<25',"BMI 25-30","BMI>30"])
plt.show()
```

!<img src="https://s1.ax1x.com/2020/08/14/dCxm8K.png" alt="output 5 0" border="0">




```python
y1 = np.log(x1/x3)
y2 = np.log(x2/x3)
plt.plot(y1)
plt.plot(y2)
plt.legend(["y1","y2"])
plt.show()
y1=pd.Series(y1).dropna()
y2=pd.Series(y2).dropna()

```



<img src="https://s1.ax1x.com/2020/08/14/dCxEU1.png" alt="output 6 0" border="0">




```python
x1=np.array(range(len(y1)))
X=np.column_stack(((x1), (x1)**2, (x1)**3))

import statsmodels.api as sm
olsmod1 = sm.OLS(y1, X)
olsres1 = olsmod1.fit()
print(olsres1.summary())
olsmod2 = sm.OLS(y2, X)
olsres2 = olsmod2.fit()
print(olsres2.summary())
```

                                     OLS Regression Results                                
    =======================================================================================
    Dep. Variable:                      y   R-squared (uncentered):                   0.720
    Model:                            OLS   Adj. R-squared (uncentered):              0.678
    Method:                 Least Squares   F-statistic:                              17.16
    Date:                Thu, 13 Aug 2020   Prob (F-statistic):                    9.41e-06
    Time:                        18:11:12   Log-Likelihood:                         -8.5158
    No. Observations:                  23   AIC:                                      23.03
    Df Residuals:                      20   BIC:                                      26.44
    Df Model:                           3                                                  
    Covariance Type:            nonrobust                                                  
    ==============================================================================
                     coef    std err          t      P>|t|      [0.025      0.975]
    ------------------------------------------------------------------------------
    x1             0.2832      0.061      4.629      0.000       0.156       0.411
    x2            -0.0291      0.008     -3.443      0.003      -0.047      -0.011
    x3             0.0008      0.000      2.842      0.010       0.000       0.001
    ==============================================================================
    Omnibus:                       16.712   Durbin-Watson:                   0.154
    Prob(Omnibus):                  0.000   Jarque-Bera (JB):               17.328
    Skew:                           1.699   Prob(JB):                     0.000173
    Kurtosis:                       5.557   Cond. No.                     3.35e+03
    ==============================================================================
    
    Warnings:
    [1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
    [2] The condition number is large, 3.35e+03. This might indicate that there are
    strong multicollinearity or other numerical problems.
                                     OLS Regression Results                                
    =======================================================================================
    Dep. Variable:                      y   R-squared (uncentered):                   0.769
    Model:                            OLS   Adj. R-squared (uncentered):              0.734
    Method:                 Least Squares   F-statistic:                              22.19
    Date:                Thu, 13 Aug 2020   Prob (F-statistic):                    1.42e-06
    Time:                        18:11:12   Log-Likelihood:                         -3.2967
    No. Observations:                  23   AIC:                                      12.59
    Df Residuals:                      20   BIC:                                      16.00
    Df Model:                           3                                                  
    Covariance Type:            nonrobust                                                  
    ==============================================================================
                     coef    std err          t      P>|t|      [0.025      0.975]
    ------------------------------------------------------------------------------
    x1             0.2471      0.049      5.068      0.000       0.145       0.349
    x2            -0.0248      0.007     -3.689      0.001      -0.039      -0.011
    x3             0.0007      0.000      3.000      0.007       0.000       0.001
    ==============================================================================
    Omnibus:                       17.646   Durbin-Watson:                   0.167
    Prob(Omnibus):                  0.000   Jarque-Bera (JB):               19.068
    Skew:                           1.754   Prob(JB):                     7.24e-05
    Kurtosis:                       5.754   Cond. No.                     3.35e+03
    ==============================================================================
    
    Warnings:
    [1] Standard Errors assume that the covariance matrix of the errors is correctly specified.
    [2] The condition number is large, 3.35e+03. This might indicate that there are
    strong multicollinearity or other numerical problems.



```python
x2=np.array(range(len(y1)+5))
X2=np.column_stack(((x2), (x2)**2, (x2)**3))
y1_f = olsres1.predict(X2)
y2_f= olsres2.predict(X2)
```


```python
x1_f = 100*np.exp(y1_f)/(1 + np.exp(y1_f) + np.exp(y2_f))
x2_f = 100*np.exp(y2_f)/(1 + np.exp(y1_f) + np.exp(y2_f))
x3_f = 100 -x1_f - x2_f
```

## 预测计数序列

### 例16.2：


```python
df=pd.read_excel("/root/experiment01/cons_share.xlsx")
x=np.array(df["other_share"])
c=np.array(df["cons_share"])
g=np.array(df["govt_share"])
i=np.array(df["inv_share"])
```


```python
y1 = np.log(c/x)
y2 = np.log(i/x)
y3 = np.log(g/x)
plt.plot(y1)
plt.plot(y2)
plt.plot(y3)
plt.legend(["y1","y2","y3"])
plt.show()
y1=pd.Series(y1).dropna()
y2=pd.Series(y2).dropna()
y3=pd.Series(y3).dropna()
```



<img src="https://s1.ax1x.com/2020/08/14/dCxPu4.png" alt="output 14 0" border="0">



```python
endog=np.column_stack((y1, y2, y3))
```


```python
from statsmodels.tsa.api import VAR
model = VAR(endog)
results = model.fit(3)
print(results.summary())
```

      Summary of Regression Results   
    ==================================
    Model:                         VAR
    Method:                        OLS
    Date:           Thu, 13, Aug, 2020
    Time:                     18:38:31
    --------------------------------------------------------------------
    No. of Equations:         3.00000    BIC:                   -19.4086
    Nobs:                     247.000    HQIC:                  -19.6632
    Log likelihood:           1428.16    FPE:                2.43171e-09
    AIC:                     -19.8348    Det(Omega_mle):     2.15875e-09
    --------------------------------------------------------------------
    Results for equation y1
    ========================================================================
               coefficient       std. error           t-stat            prob
    ------------------------------------------------------------------------
    const         0.221553         0.113086            1.959           0.050
    L1.y1         0.559874         0.575851            0.972           0.331
    L1.y2         0.033983         0.261057            0.130           0.896
    L1.y3         0.204065         0.498390            0.409           0.682
    L2.y1        -0.144935         0.691576           -0.210           0.834
    L2.y2        -0.099647         0.328240           -0.304           0.761
    L2.y3         0.415379         0.628964            0.660           0.509
    L3.y1         0.380178         0.571015            0.666           0.506
    L3.y2         0.044687         0.252893            0.177           0.860
    L3.y3        -0.454614         0.495723           -0.917           0.359
    ========================================================================
    
    Results for equation y2
    ========================================================================
               coefficient       std. error           t-stat            prob
    ------------------------------------------------------------------------
    const         0.189667         0.115814            1.638           0.101
    L1.y1        -0.026509         0.589741           -0.045           0.964
    L1.y2         0.817267         0.267354            3.057           0.002
    L1.y3        -0.015830         0.510412           -0.031           0.975
    L2.y1        -0.385279         0.708258           -0.544           0.586
    L2.y2         0.063043         0.336158            0.188           0.851
    L2.y3         0.513862         0.644135            0.798           0.425
    L3.y1         0.228954         0.584789            0.392           0.695
    L3.y2         0.060600         0.258993            0.234           0.815
    L3.y3        -0.312565         0.507680           -0.616           0.538
    ========================================================================
    
    Results for equation y3
    ========================================================================
               coefficient       std. error           t-stat            prob
    ------------------------------------------------------------------------
    const         0.202327         0.114515            1.767           0.077
    L1.y1        -0.197635         0.583128           -0.339           0.735
    L1.y2         0.002252         0.264356            0.009           0.993
    L1.y3         1.007289         0.504688            1.996           0.046
    L2.y1        -0.414684         0.700315           -0.592           0.554
    L2.y2        -0.078056         0.332388           -0.235           0.814
    L2.y3         0.653978         0.636912            1.027           0.305
    L3.y1         0.423409         0.578231            0.732           0.464
    L3.y2         0.057440         0.256089            0.224           0.823
    L3.y3        -0.511647         0.501987           -1.019           0.308
    ========================================================================
    
    Correlation matrix of residuals
                y1        y2        y3
    y1    1.000000  0.970225  0.991760
    y2    0.970225  1.000000  0.961452
    y3    0.991760  0.961452  1.000000


  

### 例16.3：


```python
df=pd.read_excel("/root/experiment01/storms.xlsx")
df.head()
```

<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>_date_</th>
      <th>storms</th>
      <th>hurricanes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>NaT</td>
      <td>6</td>
      <td>3</td>
    </tr>
    <tr>
      <td>1</td>
      <td>NaT</td>
      <td>5</td>
      <td>5</td>
    </tr>
    <tr>
      <td>2</td>
      <td>NaT</td>
      <td>8</td>
      <td>4</td>
    </tr>
    <tr>
      <td>3</td>
      <td>NaT</td>
      <td>5</td>
      <td>3</td>
    </tr>
    <tr>
      <td>4</td>
      <td>NaT</td>
      <td>5</td>
      <td>4</td>
    </tr>
  </tbody>
</table>




```python
x=np.array(df["storms"])
r1 = 0.384
r2 = 0.300
phi2 = 0.179
score = np.sqrt(x)*r1
y = x -np.mean(x)
s = np.sum(y)

y2 = pd.Series(x).shift(-2) - np.mean(x)
y1 = y*y2
s1 = np.sum(y1)
qacf = (r2**2)*(s**2)/s1
qpacf = (phi2**2)*(s**2)/s1

```


```python
# In-AR
```


```python
r1 = 0.384
r2 = 0.300
a = (x*r1 + 1)/(x - 3)
l1 = (1 - a)*np.mean(x)
a1 = r1*(1 - r2)/(1 - r1**2)
a2 = (r2 - r1**2)/(1 - r1**2)
l2 =  (1 - a1 -a2)*np.mean(x)
w1 = x - a*pd.Series(x).shift(-1) - l1
w2 = x - a1*pd.Series(x).shift(-1) - a2*pd.Series(x).shift(-1) - l2
```



### 例16.4：


```python
from math import factorial
```


```python
a = 0.397
lam = 5.78
xt = 17
x_max = 25
x_max_1 = x_max + 1
c=np.zeros(x_max)
b=np.zeros((x_max,x_max))
p=np.zeros((2,x_max_1))

for i in [1,2]:
    h = i
    for j in range(x_max):
        z = j
        c.append(0)
        for k in range(z):
            b[z][k] = (a**(k*h))*((1-(a**h))^(xt-k)*(lam**(z*k))/(factorial(k)*factorial(z-k)*factorial(abs(xt-k)))
            c[z] = c[z] + b[z][k] 
            
        scalar p[h][z] = factorial(xt)*exp(-lam*(1-(a**h))/(1-a)))*c[z]         
    for f in range(x_max_1):
        w = f - 1
        #smpl !5 !5
        p[h] = p[h][w]
        
```

